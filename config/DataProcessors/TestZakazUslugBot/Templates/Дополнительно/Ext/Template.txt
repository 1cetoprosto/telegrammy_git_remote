Процедура ПрочитатьИОбработатьСообщение(Сообщение) Экспорт

	Если Сообщение.ТипСообщения = Перечисления.ТипыСообщения.callbackquery Тогда	// Это пришёл запрос доступа

		ДанныеСообщения = Боты.ПолучитьДанныеСообщения(Бот, Сообщение.update_id);
		// ...

		// Найдём админов бота
		Запрос = Новый Запрос;
		Запрос.Текст =
		"//здесь был текст запроса";
		Запрос.УстановитьПараметр("ТекущаяДата", ТекущаяДата());
		Результат = Запрос.Выполнить();
		Если Результат.Пустой() Тогда
			Возврат;
		КонецЕсли;

		// Каждому админу отправим запрос на рассмотрение
		Выборка = Результат.Выбрать();
		Пока Выборка.Следующий() Цикл
			ИдентификаторАкцепта = Боты.СоздатьСессию(Бот, Новый Структура("Действие, Контрагент", "Акцепт", Сообщение.Контрагент));
			ИдентификаторЗапрета = Боты.СоздатьСессию(Бот, Новый Структура("Действие, Контрагент", "Запрет", Сообщение.Контрагент));

			reply_markup = СтрШаблон("{""inline_keyboard"":[[{""text"":""Разрешить"",""callback_data"":""%1""},{""text"":""Отклонить"",""callback_data"":""%2""}]]}", ИдентификаторАкцепта, ИдентификаторЗапрета);
			parse_mode = "Markdown";
			Телеграм.sendMessage(Выборка.Контрагент.ТелеграмID, СтрШаблон("Поступил запрос на предоставление доступа от [%1](http://t.me/%2).", Сообщение.Контрагент.ТелеграмИмя, Сообщение.Контрагент.ТелеграмНик), parse_mode,,,, reply_markup);
		КонецЦикла;

		ИзменитьКлавиатуруСообщения(Сообщение.Чат, ДанныеСообщения.callback_query.message.message_id);	// Удалим кнопку запроса.

	ИначеЕсли Сообщение.ТипСообщения = Перечисления.ТипыСообщения.message Тогда	// Нажал кнопку внизу или ввёл текст

		
		ДанныеСообщения = Боты.ПолучитьДанныеСообщения(Бот, Сообщение.update_id);
		
		Если СокрЛП(ДанныеСообщения.message.text) = "/start"  Тогда
			
			ТекстПлана = ПолучитьТекстПлана(ТекущаяДата());
			
			Если НЕ ТекстПлана = "" Тогда
				ТекстСообщения = "План читання на сьогодні: " + ТекстПлана;
			Иначе 
				ТекстСообщения = "На " + ТекущаяДата() + " план читання не сформовано";
			КонецЕсли;
			
			Результат = Телеграм.sendMessage(Сообщение.Чат, ТекстСообщения);
			
		КонецЕсли;
		
		Попытка
			Кнопка = НРег(ДанныеСообщения.message.text);
		Исключение
			Кнопка = "";
		КонецПопытки;

		Если Кнопка = "НазваниеКнопки1" Тогда

			ПараметрыЗапроса = Новый Структура("reply_markup", "{""inline_keyboard"":[[{""text"":""Завершить"",""callback_data"":""Завершить""},{""text"":""Отменить"",""callback_data"":""Отменить""}]]}");
			ОтправитьСообщение(Сообщение.Чат, "Укажите все бла-бла. По завершению нажмите нужную кнопку в этом сообщении.",, ПараметрыЗапроса);

		ИначеЕсли Кнопка = "НазваниеКнопки2" Тогда

			ПараметрыЗапроса = Новый Структура("reply_markup", "{""keyboard"":[[{""text"":""ПерманентнаяКнопка1""}],[{""text"":""ПерманентнаяКнопка2""}]],""resize_keyboard"":true}");
			ОтправитьСообщение(Сообщение.Чат, "Вы исключены из списка.",, ПараметрыЗапроса);

		Иначе

			// Проверим, не команда ли это
			Команда = ДоступныеКоманды(Кнопка);
			Если НЕ Команда.Пустая() Тогда
				Выполнить(Команда.Обработчик + "(Сообщение)");
			КонецЕсли;
			
		КонецЕсли;

		// А это кусок другого бота, поэтому он тут смотрится нелепо, но нужен для примера отправки файлов
		Если Ложь Тогда

			// Родитель - любой объект базы, подключенный к подсистеме "ПрисоединенныеФайлы"
			Родитель = Справочники.Контрагенты.ПустаяСсылка();

			ЧатСтрокой = Формат(Выборка.chat_id, "ЧГ=");
			МассивПрисоединенныхФайлов = Новый Массив;
			ПрисоединенныеФайлы.ПолучитьПрикрепленныеФайлыКОбъекту(Родитель, МассивПрисоединенныхФайлов);
			Если МассивПрисоединенныхФайлов.Количество() Тогда
				Материал = МассивПрисоединенныхФайлов[0];
			ИначеЕсли Родитель.ВидМатериала = ПредопределенноеЗначение("Перечисление.ВидыМатериалов.Текст") Тогда
				Телеграм.sendMessage(ЧатСтрокой, Родитель.Текст); 
			Иначе

				Если Родитель.ВидМатериала = ПредопределенноеЗначение("Перечисление.ВидыМатериалов.Документ") Тогда

					ОтправитьМатериал(ЧатСтрокой, Материал, "sendDocument", "document");

				ИначеЕсли Родитель.ВидМатериала = ПредопределенноеЗначение("Перечисление.ВидыМатериалов.Картинка") Тогда

					ОтправитьМатериал(ЧатСтрокой, Материал, "sendPhoto", "photo");

				ИначеЕсли Родитель.ВидМатериала = ПредопределенноеЗначение("Перечисление.ВидыМатериалов.Аудио") Тогда

					ОтправитьМатериал(ЧатСтрокой, Материал, "sendAudio", "audio");

				ИначеЕсли Родитель.ВидМатериала = ПредопределенноеЗначение("Перечисление.ВидыМатериалов.Видео") Тогда

					ОтправитьМатериал(ЧатСтрокой, Материал, "sendVideo", "video");

				КонецЕсли;
			КонецЕсли;

		КонецЕсли;

	ИначеЕсли Сообщение.ТипСообщения = Перечисления.ТипыСообщения.location Тогда

		СессияКонтрагента = Боты.ПолучитьОписаниеСессииКонтрагента(Сообщение.Контрагент);
		Если СессияКонтрагента.Свойство("Действие") Тогда
			Если СессияКонтрагента.Действие = "ОжиданиеЛоки" Тогда
				// тут был код
			КонецЕсли;
		КонецЕсли;

	КонецЕсли;

	Если Результат["ok"] Тогда
		Боты.ЗакрытьСообщение(Бот, Сообщение.update_id);	
	КонецЕсли;

КонецПроцедуры